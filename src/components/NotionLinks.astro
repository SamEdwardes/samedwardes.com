---
export const prerender = false;
import { Client, isFullPage } from "@notionhq/client";
import BrutalPill from "../components/BrutalPill.astro";
import BrutalButton from "../components/BrutalButton.astro";

// -----------------------------------------------------------------------------
// Call Notion API
// -----------------------------------------------------------------------------
const notion = new Client({
  auth: process.env.NOTION_TOKEN,
});

const fullOrPartialPages = await notion.databases.query({
  // Webclips URL: https://www.notion.so/samedwardes/18594cc9dbcb4ca6984984f6beb03b81?v=bcb531df9d15439eb5130e8723583f6c&pvs=4
  database_id: "18594cc9dbcb4ca6984984f6beb03b81",
  filter: {
    property: "Public",
    checkbox: {
      equals: true,
    },
  },
});

// -----------------------------------------------------------------------------
// Extract data from Notion API response
// -----------------------------------------------------------------------------

// Type guards for property types
function isCheckboxProperty(property: any): property is { checkbox: boolean } {
  return property?.type === "checkbox";
}

function isTitleProperty(
  property: any,
): property is { title: [{ plain_text: string }] } {
  return property?.type === "title";
}

function isUrlProperty(property: any): property is { url: string } {
  return property?.type === "url";
}

function isFormulaStringProperty(
  property: any,
): property is { formula: { string: string } } {
  return property?.type === "formula" && property.formula.type === "string";
}

function isMultiSelectProperty(
  property: any,
): property is { multi_select: { name: string }[] } {
  return property?.type === "multi_select";
}

function isRichTextProperty(
  property: any,
): property is { rich_text: [{ plain_text: string }] } {
  return property?.type === "rich_text";
}

export interface PageLink {
  id: string;
  created_time: Date;
  publiclyVisible: boolean;
  title: string;
  url: string;
  base_url: string;
  tags: string[];
  description?: string;
}

// Refactored function to extract page link
function extractPageLink(page: any): PageLink {
  if (!isFullPage(page)) throw new Error("Not a full page object");

  const {
    Public: publicProp,
    Name: nameProp,
    URL: urlProp,
    "Base URL": baseUrlProp,
    "Public Tags": tagsProp,
    "Public Description": descriptionProp,
  } = page.properties;

  if (
    !isCheckboxProperty(publicProp) ||
    !isTitleProperty(nameProp) ||
    !isUrlProperty(urlProp) ||
    !isFormulaStringProperty(baseUrlProp)
  ) {
    throw new Error("Invalid property types");
  }

  const publiclyVisible = publicProp.checkbox;
  const title = nameProp.title[0]?.plain_text ?? "";
  const linkURL = urlProp.url ?? "";
  const base_url = baseUrlProp.formula.string ?? "";
  const tags = isMultiSelectProperty(tagsProp)
    ? tagsProp.multi_select.map((tag) => tag.name)
    : [];
  const description = isRichTextProperty(descriptionProp)
    ? descriptionProp.rich_text[0]?.plain_text
    : undefined;

  return {
    id: page.id,
    created_time: new Date(page.created_time),
    publiclyVisible,
    title,
    url: linkURL,
    base_url,
    tags,
    description,
  };
}

// Use the refactored function in the map
const pageLinks = fullOrPartialPages.results
  .map(extractPageLink)
  .sort((a, b) => b.created_time.getTime() - a.created_time.getTime());

// Helper function for UI
function formatDateWithoutDay(dateInput: Date) {
  const date = new Date(dateInput);
  const day = date.getDate();
  const month = date.getMonth() + 1; // Adjust for zero-index
  const year = date.getFullYear();
  return `${year}-${month}-${day}`;
}
---

<div>
  <!-- TODO: add tag filter, date filter, and search -->
  <div
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
  >
    {
      pageLinks.map((page) => {
        return (
          <BrutalButton href={page.url} target="_blank">
            <div class="flex flex-col h-full">
              <h2 class="font-bold">{page.title}</h2>
              <p class="text-sm pt-2">{page.description}</p>
              <div class="grow" />
              <div class="pt-4">
                <p class="text-xs font-extralight italic">
                  Added on {formatDateWithoutDay(page.created_time)}
                </p>
                <p
                  class:list={[
                    "text-gray-600 text-xs font-extralight truncate italic",
                    "hover:underline after:content-['_â†—']",
                    "justify-self-end",
                  ]}
                >
                  {page.url}
                </p>
                <p class="pt-2 flex flex-row gap-1 -ml-3">
                  {page.tags.map((tag) => (
                    <BrutalPill class="bg-white">{tag}</BrutalPill>
                  ))}
                </p>
              </div>
            </div>
          </BrutalButton>
        );
      })
    }
  </div>
</div>
